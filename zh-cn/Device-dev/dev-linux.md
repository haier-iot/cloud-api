# Linux SmartDevice SDK

  
## 基本功能 ##

SmartDevice SDK Linux版（设备SDK-Linux版）是一款基于Linux系统的应用开发套件，能够使用在Linux系统的智能设备上，将设备接入到U+平台，可实现与U+其他设备交互。
设备SDK-Linux按照实际需求可以分为设备接入版、全功能版、插件版3个版本：

**1、设备接入版**：即SDK设备侧， 可实现设备接入到U+云平台。  
主要功能：上线宣告、接收控制指令、上报属性信息、上报报警信息、上报大数据信息等基础功能，以及接入环境自定义、FOTA功能、P2P功能、http域名解析功能、本地局域网控制、主设备绑定子设备、毕加索配置功能、本地消息透传、远程消息推送功能和直连绑定功能等。

**2、全功能版：** 
全功能版SDK=SDK设备侧+SDK用户侧，包含设备接入版SDK全部功能，在设备接入版基础上，增加了控制其他U+设备功能(SDK用户侧) ，用于将设备接入U+云平台的同时实现控制同账号下的其他设备。  
主要业务功能：包括接入设备到U+平台的功能，以及搜索设备、配置其他设备入网、获取设备列表、控制设备、获取设备上报数据、获取设备bindkey、查询设备属性、获取报警上报、本地消息透传、找队友等功能。

**3、插件版：**在全功能版基础上，增加了SDK的串口通信库（本版SDK目前支持的E++协议为2.17/2.18）
主要功能：在全功能版基础上，由SDK接管与海尔标准E++协议设备的电脑板之间的串口通信。


![][特点]

## 能力介绍 ##

**FOTA功能**  
支持三种方式：①设备主动发起升级；②手机APP进行主动升级；③平台进行强制升级；
升级包的下载有两种方式开发者自由选择：升级包下载函数默认使用SDK内部的下载接口，当开发者注册使用自己的下载函数(*ugw_dev_ota_download_func)时，SDK则使用开发者注册的下载函数进行下载，开发者需根据收到的回调完成升级包的下载。

**图片资源上报功能**  
支持上传大容量图片资源，smartdevice通过特定的通道直接将资源上传到U+云平台，为确保资源的安全性，此功能只支持在大循环进行传输。

**音视频功能**  
支持APP端和设备端音视频双向通信，音视频资源支持本地存储、APP直播推送、云端存储(增值服务)。

**HTTP域名解析功能**  
SDK设备侧初始化默认会开启httpDNS功能，使用HTTP协议进行域名解析，域名解析请求绕过运营商的Local DNS，直接发送到云端的HTTPDNS服务器，能够避免Local DNS造成的域名劫持问题和调度不精准问题，可以保证设备准确、稳定的连接到U+云平台的生产环境，因此产品正式上线时不要关闭httpDNS功能。
注：如果开发者需自定义设置路由器DNS地址，使设备连到海尔云平台不同的环境(如验收环境)，可以调用关闭httpDNS功能接口；

**本地局域网控制功能(localkey储存)**  
SDK设备侧内部能够实现localkey的获取、保存和读取功能，SDK在连接海尔云平台成功后，会自动获取并保存localkey，通功此功能可以保证设备在断网的情况下重启，也能够被控制。。
SDK用户侧订阅完设备后，能够获取被订阅设备的localkey并保存。通过此功能可以保证设备在断网的情况下重启，小循环内也是能够被控制。

**主设备绑定子设备功能**  
设备绑定设备功能，当添加的主设备被绑定到某一账号下后，再次添加子设备或附件设备时，可以直接通过smartdevice单机版侧接口直接将子设备绑定到主设备所在的账号下。使用此功能，对于有多个子设备或附件设备的使用场景，手机端只需要绑定一次主设备，之后其他设备如果需要绑定到主设备所在的账号下时，可以直接通过设备绑定设备接口在smartdevice SDK侧执行绑定即可，减少手机端单一重复的操作。

**设备共享功能**  
通过设备绑定设备接口绑定的子设备，能够支持分享功能。如果子设备被设置为可共享设备，那么它在uSDK侧就能够被分享给指定的成员或家庭。

**支持添加多类型、多个设备**  
支持添加网关设备、普通设备、子设备和附件设备。
网关设备可以作为网关，当网关设备被绑定后，其能够直接绑定子设备和附件设备到网关所在的用户下，也能够解绑子设备与附件设备。
子设备为与网关设备同一系统下的下级设备，如开关设备。
附件设备为与子设备同一系统下的附属设备，如可被开关设备控制的灯光类设备。

**毕加索配置**  
毕加索（BLE+softap） smartdevice的一种配置模式。在此模式下，smartdevice支持BLE辅助Wi-Fi配网和softAP配网两种配置方式同时共存。用户可以自由选择使用BLE辅助Wi-Fi配网或softAP配网，哪种方式先连接成功smartdevice则使用哪种配置方式进行配置，此方法有助提高配置成功率。
注：如果实现BLE辅助Wi-Fi配网，需要用户系统进行BLE适配，否则只有softAP配置。如需要BLE辅助Wi-Fi配网，请在《IoT-SDKs静态库申请表》标注清晰并申请BLE适配。

**本地消息透传功能**     
本功能需在全功能版本上实现使用，主设备和子设备间可以通过消息透传接口进行自定义消息的传输。

**远程消息推送功能**  
Smartdevice提供推送功能，即SmartDevice可以接收优家IoT云服务发来的推送消息，并透传给设备应用使用，smartdevice对推送的消息不做任何处理。

**直连绑定功能**  
当设备可以直接连接网络时，可以使用直连绑定功能，设备以验证码或按键触发的方式和APP进行交互，进而完成绑定操作。
注：直连绑定方式需按网关设备类型添加设备。
 

## 运行环境 ##
1.	使用动态库时，启动设备接入程序前需设置SDK动态库的加载路径。
2.	SDK只支持typeID为2开头的设备进行接入，即添加设备时只支持添加uplusid参数为2开头的设备；
3.	设备接入版SDK运行的最低资源要求：  
  A、32位系统：RAM不小于4MB，Flash不小于4MB；  
  B、64位系统：RAM不小于7MB，Flash不小于4MB；
4.	全功能版SDK运行的最低资源要求：  
A、 32 位系统： RAM 不小于 7MB， Flash 不小于 4MB；  
B、 64 位系统： RAM 不小于 10MB， Flash 不小于 4MB

## 海极网配置 ##
在进行正式的设备开发之前，需先在海极网开放平台下创建产品，配置必要的设备信息对设备建模，生成设备的功能模型文档，详情请参考海极网产品接入引导说明：
https://www.haigeek.com/docs-page/#/zh-cn/DeviceGuide/directDevice/process.md





## 常见问题 ##

**1、 初始化失败**    
A、 初始化相关参数设置错误，可能引起后期部分功能使用异常；   
B、 系统缺少回环网卡；   
C、 系统 5353 端口被其他程序占用；   
D、 SDK 异常重启时，若 SDK 的某模块没有正常关闭，会导致再次启动 SDK 时相关资源被占用，需手动清除后台进程后再次启动；   
E、 因平台间的差异， SDK 初始化可能会被系统的某些进程打断，导致初始化失败，此时需要循环进行初始化，直到初始化成功后再进行后续操作。   
F、 SDK设备侧初始化前可设置日志级别并生效；全功能版只有在ugw_inti 初始化完成后才能设置日志级别；   

**2、 回调**   
A、 回调函数均需要开发者进行实现，否则会有异常；   
B、 回调函数中禁止调用 SDK 的其他接口函数，尤其是同步接口，相关的操作需开发者在自己的线程中处理；
   
**3、 添加设备**   
A 、添加设备接口中的 uplusid 和 key 分别对应海极网的 TYPEID 和 deviceKey一定要传对（复制粘贴操作）；   
B 、当系统有且只有一个设备时，必须按网关设备注册+上线；(不区分海极网创建是网关设备还是普通设备)   
C 、海极网生成的 TYPEID 和 deviceKey 默认只在生产环境和开发者环境中有效，如果开发者想在其他环境进行测试，需要联系支持人员将 TYPEID 和 deviceKey 同步到相应的环境下；   
D、设备被删除：在添加设备时若 CPU 资源被占满，导致添加设备超时(大于5S)， SDK 会进行删除设备操作；   
若添加设备相关接口执行失败时，建议增加一定延时后再次进行调用，直至成功（接口返回0）为止；   
 E、添加设备时网关设备上线接口ugw_master_dev_online常见的相关错误含义：   
①eflag:-2, ret:-9：传入的设备角色和添加的设备不匹配   
②eflag:-8, ret:-9：整机固件类型没有填写   
③eflag:-5, ret:-9 ：双向认证的证书路径 没有包含证书的文件名   
④eflag:-11, ret:-5001：同一个个设备上只能启动一个smartdevice， 看下在启动时是否有SDK已经启动了，验证：ps进程过滤程序名（或者杀掉重启也可以验证）      


**4、 配置**    
A、 配置功能分为用户侧配网和设备侧配网。   
用户侧配网指全功能版配置单机版设备或其他海尔 wifi 设备入网的操作，支持 smartlink 和 SoftAP 配置方式；   
设备侧配网是指设备自身被 APP 或者全功能版 SDK 配置入网的操作，只支持 毕加索配置方式，无smartlink；   
B、 设备侧进行毕加索配置时，   
①开发者需要按照回调通知自己实现系统网卡在softAP 和 station工作模式间的切换；   
②当SDK触发启动AP模式通知回调时，开发者实现网卡切到AP模式，网卡IP须为192.168.0.1，POOL范围为192.168.0.2~192.168.0.254热点名格式为:U-设备中类缩写-XXXX(MAC后四位)，当XXXX后有-1或-2后缀时需过滤掉-1/2再生成（预留功能）。   
③当正常配置流程完成后， SDK 会自动调用结束配置接口，无需手动停止；   
④如果收到 token，那么配置完成后会自动绑定到此token 对应的账号下；   
C、 用户侧进行 soft AP 配置时，开发者需要自己实现连接到待配置的设备 AP，然后再调用用户侧 soft AP 配置接口进行配置， 最后开发者再将系统连接到之前的网络；   
D、 用户侧进行 smartlink 配置， 使用 smartlink 配置的异步接口时，才能够中途调用停止接口中断配置；   
E、 用户侧进行 smartlink 配置时，会同时发送组播和广播包数据，底层系统要保证Smartdevice 的数据能够完整的发送出来；   

**5、连云相关异常**   
A、设备未连接外网   
B、设备配置后已连接外网，但SDK尚未连云成功：开发者可通过连云状态回调了解SDK连云状态，用于做各种业务功能执行的判断依据。(连云失败252、 连云成功为251、连云中299)   
C 、系统时间与当前时间不同步：设备在联网成功后应先更新系统时间，若系统时间和当前时间相差较远，会导致 SDK 连云认证失败（或被平台踢掉）， SDK无法正常接入云平台, 会影响后续业务功能的进行；   
D、添加设备时传入参数不准确：即使后期连云成功，云平台校验不通过也会踢掉设备，SDK离线。   

**6、 绑定和开窗**
A、设备侧发起的绑定和绑定时间窗无关(毕加索配置中当SDK设备侧收到配置信息中有token可直接绑定）；   
绑定时间窗用于用户侧发起的绑定，对用户侧绑定设备的时长做出限制，超过时间窗有效期bindkey失效    
（设备的bindkey：是设备向云平台申请的，提供给用户侧用于绑定设备自身）   
B、用户侧绑定前，需先开启设备绑定时间窗，在时间窗开启成功有效期内进行绑定，若超时需重新开窗；   
C、 设备侧配置后需等待SDK 连云平台成功之后再开启绑定时间窗，若配置后立即开窗容易导致开窗失败；   
D、通过用户侧获取 bindkey 时，需要在开窗成功和订阅设备之前，调用 ugw_control_get_dev_bindinfo 接口获取bindkey；（只有设备侧开启绑定时间窗后， SDK 才能够获取到自身bindkey）   
E、 用户侧设置 token 后是无法自动绑定到对应账号下的， 还要再调用执行绑定操作才能够绑到指定账号；   
F、 添加设备时，传入的设备信息不正确、不匹配，云平台无法识别或校验失败，导致绑定失败；   
G、 设备自绑定接口ugw_dev_bind_dev返回-5005(查询为ACCESS_NO_FIND_DEV)，传入devid不匹配导致。   
   
**7、 APP端设备未就绪**   
1、 设备未被绑定（没有用户归属）；      
2、设备程序未实现获取所有属性(getAllProperty)操作应答，当获取所有属性应答为空或失败时设备无法就绪；   
3、设备侧的typeid和认证KEY需传入在海极网创建的对应设备的准确值（复制粘贴）。   
4、初始化完成后，如果设备网卡IP发生了变化，需要调用刷新网络接口（ugw_dev_refresh_network），否则设备无法连接网络，进而无法就绪。   


**8、 控制（用户侧功能）**   
A、 要求绑定在同一账号下且被控设备被用户侧订阅：当调用SDK用户侧接口实现控制本机设备或者海尔其他 wifi 设备时，所有设备必须绑定在同一账号下，且用户侧需通过订阅接口订阅了要去控制的设备；   
B、 要求当前设备具备控制能力：需要确认当前设备已经具备控制能力，即已被云端授权或设置了 token；   
C、  组命令和单命令的下发：下发组命令和 getAllProperty 和 getAllAlarm 等命令时使用ugw_control_operation（操作）， 下发单命令时使用 ugw_control_write_property（写）；    
D、 控制老的六位码设备方式：下发2000zz（获取所有属性） 和 2000zx（获取所有报警） 等命令时，不能够使用 ugw_control_operation 接口，需使用ugw_control_write_property 接口按照单命令的格式进行下发；   
E、授权设备重启无需重新授权：对设备授权后，授权状态会一直有效，除非对设备解除授权。   
F、老版SDK特殊流程：Token 和 localkey 在SDK 5.3.0 及以前版本不保存，需要开发者每次重新上电后传 token， SDK 再拿 token 去平台获取 localkey，从而获取控制能力
   
**9、 离线**   
A、 SDK 发送心跳包，平台收到心跳后会应答，若 55 秒没有收到会重新发送，重新发送两次，如果 3 分钟均没收到平台的心跳回复，设备主动离线；相同机制，如果网关平台 3 分钟没有收到心跳包，同样会断开连接；   
B、 网络原因导致连接不上平台，当 CAE 调用底层 connect 接口去连接服务器时，connect 返回错误码 265: No route to host，表示网络不可达， 说明为设备网络不通，相关日志举例为：[domain 203.130.41.39 res_id 4 ip 203.130.41.39][connect fd 23 ret -1 err 265: No route to host]    
C、 每次向云平台上报数据， CAE 均会调用多个系统 API 去执行写操作，当执行超时[CAE][D][2019-05-22 14:15:37.626000][coap_retransmit:663][retransmission#2 of tid 43203, id 52495, now -9716095 base 18954 timeout 2332 t -9725721]， 超时 3000ms 会主动断开连接并重新联网，此超时可能为网络连接原因或者系统上报数据量大且频繁导致；



[特点]:_media/_linux/Linuxfeature.png 